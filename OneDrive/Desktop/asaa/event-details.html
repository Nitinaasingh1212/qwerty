<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - CornerClub</title>
    <meta name="description"
        content="View event details, date, time, venue, and ticket pricing. Book your spot now on CornerClub.">

    <!-- Open Graph (Dynamic content will be updated by JS, these are fallbacks) -->
    <meta property="og:type" content="event">
    <meta property="og:site_name" content="CornerClub">
    <meta property="og:image" content="https://cornerclub.in/assets/og-event-placeholder.jpg">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="text/javascript">
        (function () {
            // https://dashboard.emailjs.com/admin/account
            emailjs.init("Ui-cGNR7fSTMC88jZ"); // Updated with User's Public Key
        })();
    </script>
    <style>
        :root {
            --primary: #6d28d9;
            --secondary: #1e1b4b;
            --text-dark: #1e293b;
            --text-light: #64748b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            /* Switched to White */
            color: #1e293b;
            /* Switched to Dark Text */
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
            /* Dark text */
            text-decoration: none;
            font-size: 16px;
            margin-bottom: 20px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .back-btn:hover {
            opacity: 1;
        }

        /* Hero Section (Image) */
        .event-hero {
            position: relative;
            width: 100%;
            height: auto;
            /* Allow auto height */
            min-height: 300px;
            border-radius: 20px;
            overflow: hidden;
            background-color: #333;
            margin-bottom: 30px;
        }

        .event-hero img {
            width: 100%;
            height: auto;
            /* Natural height */
            max-height: 600px;
            /* Cap it but allow seeing it all */
            object-fit: contain;
            /* Ensure full image is seen */
            /* Removed mask gradient to show clear bottom */
        }

        /* Content Grid */
        .event-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
        }

        /* Left Column */
        .event-main h1 {
            font-size: 48px;
            margin: 0 0 10px 0;
            font-weight: 700;
        }

        .event-meta-row {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #64748b;
            /* Gray text */
            margin-bottom: 40px;
            font-size: 16px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Price Tag */
        .price-tag {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .share-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(0, 0, 0, 0.05);
            /* Light gray bg */
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: #1e293b;
            /* Dark icon */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        /* Organizer Card */
        .organizer-card {
            background: #f8fafc;
            /* Light gray card */
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .organizer-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .organizer-info h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .organizer-info p {
            margin: 4px 0 0;
            font-size: 14px;
            color: #64748b;
        }

        .verified-badge {
            color: #3b82f6;
            font-size: 14px;
        }

        /* Right Column (Booking) */
        .booking-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .booking-card h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .booking-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #64748b;
            font-size: 14px;
        }

        .book-btn {
            width: 100%;
            background: #6d28d9;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(109, 40, 217, 0.3);
            margin-top: 20px;
        }

        .book-btn:hover {
            background: #5b21b6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(109, 40, 217, 0.4);
        }

        .description-box {
            margin-top: 20px;
            color: #334155;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .event-grid {
                grid-template-columns: 1fr;
            }

            .event-hero {
                height: 250px;
            }

            .event-main h1 {
                font-size: 32px;
            }
        }

        /* Portfolio */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .portfolio-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid #e2e8f0;
        }

        .portfolio-img:hover {
            transform: scale(1.05);
        }

        /* Chat Room Styles */
        .chat-container {
            margin-top: 40px;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.own {
            align-self: flex-end;
            background: #6d28d9;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.other {
            align-self: flex-start;
            background: #f1f5f9;
            /* Light gray bubble */
            color: #1e293b;
            /* Dark text */
            border-bottom-left-radius: 2px;
        }

        .message-sender {
            font-size: 11px;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .chat-input-area {
            padding: 15px;
            background: #f8fafc;
            display: flex;
            gap: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .chat-input {
            flex: 1;
            background: #ffffff;
            border: 1px solid #cbd5e1;
            padding: 10px 15px;
            border-radius: 25px;
            color: #1e293b;
            outline: none;
        }

        .chat-input:focus {
            border-color: #6d28d9;
        }

        .send-btn {
            background: #6d28d9;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #5b21b6;
        }

        .login-prompt-chat {
            text-align: center;
            padding: 20px;
            color: #888;
        }
    </style>
</head>

<body>

    <div class="container">
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back
        </a>

        <div id="loading" style="text-align: center; padding: 50px;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
        </div>

        <div id="eventContent" style="display: none;">
            <!-- Hero -->
            <div class="event-hero">
                <img id="eventImage" src="" alt="Event Cover">
            </div>

            <!-- Content -->
            <div class="event-grid">
                <!-- Left: Info -->
                <div class="event-main">
                    <h1 id="eventTitle">Loading...</h1>

                    <div class="event-meta-row">
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="eventLocation">Location</span>
                        </div>
                        <div class="meta-item">
                            <i class="far fa-calendar"></i>
                            <span id="eventDate">Date</span>
                        </div>
                        <div class="meta-item">
                            <i class="far fa-clock"></i>
                            <span id="eventTime">Time</span>
                        </div>
                    </div>
                    <div class="price-tag">
                        <span id="eventPrice">â‚¹0</span>
                        <div class="share-actions">
                            <button class="icon-btn" onclick="openShareModal()"><i
                                    class="fas fa-share-alt"></i></button>
                            <button class="icon-btn" id="likeBtn" onclick="toggleLike()"><i
                                    class="far fa-heart"></i></button>
                        </div>
                    </div>

                    <!-- Organizer -->
                    <div class="organizer-card">
                        <img src="https://via.placeholder.com/50" alt="Organizer" class="organizer-img"
                            id="organizerImg">
                        <div class="organizer-info">
                            <h3><span id="organizerName">Organizer</span>
                                <i class="fas fa-check-circle" style="color: #6d28d9; margin-left: 5px;"
                                    title="Verified"></i>
                            </h3>
                            <p>Host of this event</p>
                            <div style="margin-top: 5px;" id="organizerSocials">
                                <i class="fab fa-instagram" style="color: #e1306c; opacity: 0.5;"></i>
                            </div>
                        </div>
                    </div>

                    <h3>About this event</h3>
                    <p class="description-box" id="eventDescription">
                        Loading description...
                    </p>

                    <!-- Portfolio Section -->
                    <div id="portfolioSection" style="margin-top: 40px; display: none;">
                        <h3>Past Work / Portfolio</h3>
                        <div class="portfolio-grid" id="portfolioContainer"></div>
                    </div>

                    <!-- Chat Section -->
                    <div class="chat-container" id="chatRoom">
                        <div class="chat-header">
                            <h3>Event Chat Room</h3>
                            <span class="live-badge"
                                style="background: red; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px;">LIVE</span>
                        </div>
                        <div id="chatMessages" class="chat-messages">
                            <!-- Messages will load here -->
                            <div style="text-align: center; color: #666; margin-top: 100px;">
                                <i class="fas fa-comments fa-2x"></i>
                                <p>Join the conversation!</p>
                            </div>
                        </div>

                        <div id="chatInputArea" class="chat-input-area" style="display: none;">
                            <input type="text" id="messageInput" class="chat-input" placeholder="Type a message..."
                                autocomplete="off">
                            <button id="sendMessageBtn" class="send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div id="chatLoginPrompt" class="login-prompt-chat">
                            <a href="login.html" style="color: #6d28d9; text-decoration: none; font-weight: bold;">Log
                                in</a> to join the chat
                        </div>
                    </div>
                </div>

                <!-- Right: Booking -->
                <div class="booking-sidebar">
                    <div class="booking-card">
                        <h3>Booking Info</h3>
                        <div class="booking-stat">
                            <span>Total Capacity</span>
                            <span id="totalCapacity">0</span>
                        </div>
                        <div class="booking-stat">
                            <span>Spots Left</span>
                            <span id="spotsLeft" style="color: #10b981;">Available</span>
                        </div>

                        <button class="book-btn" onclick="openBooking()">
                            <span>Book Now</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorMessage" style="display: none; text-align: center; padding: 50px; color: #ef4444;">
            <h2>Event not found</h2>
            <p>The event you are looking for does not exist or has been removed.</p>
        </div>

        <!-- Share Modal (Copied from index.html) -->
        <div class="share-modal" id="shareModal">
            <div class="share-modal-content">
                <button class="close-modal" id="closeModal" onclick="closeShareModal()">&times;</button>
                <h3>Share Event</h3>
                <div class="share-options">
                    <div class="share-option facebook-bg" onclick="shareOnFacebook()">
                        <i class="fab fa-facebook-f"></i>
                    </div>
                    <div class="share-option twitter-bg" onclick="shareOnTwitter()">
                        <i class="fab fa-twitter"></i>
                    </div>
                    <div class="share-option whatsapp-bg" onclick="shareOnWhatsApp()">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <div class="share-option link-bg" onclick="copyEventLink()">
                        <i class="fas fa-link"></i>
                    </div>
                </div>
                <div class="share-url">
                    <input type="text" id="eventLink" value="" readonly>
                    <button onclick="copyEventLink()">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="share-modal" style="display: none;">
        <div class="share-modal-content" style="text-align: left; max-width: 450px;">
            <button class="close-modal" onclick="closeBookingModal()">&times;</button>
            <h3 style="margin-bottom: 20px; text-align: center;">Book Tickets</h3>

            <div style="margin-bottom: 15px;">
                <p style="font-size: 14px; color: #666;">Event</p>
                <h4 id="modalEventTitle" style="font-size: 18px;">Event Name</h4>
            </div>

            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                <div>
                    <p style="font-size: 14px; color: #666;">Price per ticket</p>
                    <p id="modalTicketPrice" style="font-weight: bold;">â‚¹0</p>
                </div>
                <div style="text-align: right;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 5px;">Quantity</p>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button onclick="updateQuantity(-1)"
                            style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer;">-</button>
                        <span id="ticketQuantity" style="font-weight: bold; width: 20px; text-align: center;">1</span>
                        <button onclick="updateQuantity(1)"
                            style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer;">+</button>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <span style="font-size: 18px; font-weight: bold;">Total</span>
                <span id="modalTotalPrice" style="font-size: 24px; font-weight: bold; color: #6d28d9;">â‚¹0</span>
            </div>

            <button id="payBtn" onclick="initiatePayment()" class="book-btn" style="margin-top: 0;">
                Pay Now
            </button>
        </div>

        <!-- Premium Ticket Receipt Modal -->
        <div id="ticketModal" class="share-modal" style="display: none; align-items: center; justify-content: center;">
            <div class="share-modal-content"
                style="width: 100%; max-width: 380px; background: transparent; padding: 0; box-shadow: none;">

                <!-- Ticket Container -->
                <div
                    style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative;">

                    <!-- Header -->
                    <div
                        style="background: linear-gradient(135deg, #6d28d9, #8b5cf6); padding: 30px 20px; text-align: center; color: white; position: relative;">
                        <div style="font-size: 50px; margin-bottom: 10px;">ðŸŽ‰</div>
                        <h2 style="margin: 0; font-size: 24px;">Booking Confirmed!</h2>
                        <p style="margin: 5px 0 0; opacity: 0.9;">Your ticket is ready</p>

                        <!-- Semi-circle cutout (top) -->
                        <div
                            style="position: absolute; bottom: -15px; left: -15px; width: 30px; height: 30px; background: #333; border-radius: 50%;">
                        </div>
                        <div
                            style="position: absolute; bottom: -15px; right: -15px; width: 30px; height: 30px; background: #333; border-radius: 50%;">
                        </div>
                    </div>

                    <!-- Dotted Line Divider -->
                    <div
                        style="height: 4px; background: #fff; border-bottom: 3px dashed #e5e7eb; position: relative; z-index: 1;">
                    </div>

                    <!-- Body -->
                    <div style="padding: 30px 25px; text-align: center; position: relative;">
                        <!-- Semi-circle cutout (bottom matches top) -->
                        <div
                            style="position: absolute; top: -15px; left: -15px; width: 30px; height: 30px; background: #333; border-radius: 50%;">
                        </div>
                        <div
                            style="position: absolute; top: -15px; right: -15px; width: 30px; height: 30px; background: #333; border-radius: 50%;">
                        </div>

                        <img src="" id="ticketQR" alt="Ticket QR"
                            style="width: 140px; height: 140px; border: 4px solid #f3f4f6; border-radius: 12px; padding: 5px; margin-bottom: 20px;">

                        <h3 id="ticketEventTitle" style="margin: 0 0 5px; font-size: 20px; color: #1f2937;">Event Name
                        </h3>
                        <p id="ticketLocation" style="margin: 0 0 20px; color: #6b7280; font-size: 14px;">Location</p>

                        <div style="background: #f9fafb; border-radius: 12px; padding: 15px; margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #6b7280; font-size: 13px;">Date & Time</span>
                                <span id="ticketDate" style="font-weight: 600; color: #374151; font-size: 13px;">Oct 24,
                                    7:00 PM</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #6b7280; font-size: 13px;">Tickets</span>
                                <span id="ticketCount" style="font-weight: 600; color: #374151; font-size: 13px;">2
                                    Persons</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-size: 13px;">Booking ID</span>
                                <span id="ticketId"
                                    style="font-family: monospace; font-weight: 600; color: #6d28d9; font-size: 13px;">#123456</span>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div style="display: grid; gap: 10px;">
                            <button onclick="downloadTicket()"
                                style="background: #6d28d9; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;">
                                <i class="fas fa-download"></i> Download Ticket
                            </button>
                            <!-- Optional Profile Link -->
                            <!-- <button onclick="window.location.href='profile.html'" 
                                style="background: white; color: #6d28d9; border: 1px solid #6d28d9; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;">
                                View My Bookings
                            </button> -->
                            <button onclick="closeTicketModal()"
                                style="background: transparent; color: #6b7280; border: none; padding: 10px; cursor: pointer; font-size: 14px;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>CornerClub</h3>
                <p>Building communities through shared experiences.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="terms.html">Terms & Conditions</a></li>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                    <li><a href="refund.html">Refund Policy</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Categories</h3>
                <ul>
                    <li><a href="#">Music Events</a></li>
                    <li><a href="#">Food Festivals</a></li>
                    <li><a href="#">Tech Conferences</a></li>
                    <li><a href="#">Art Exhibitions</a></li>
                </ul>
            </div>
        </div>
        <p>&copy; 2026 cornerclub.in. All rights reserved. (v1.1)</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="animations.js"></script>
    <script type="module">
        import { db, doc, getDoc, setDoc, auth, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy } from './firebase-config.js';

        // Helper to get ID from URL
        function getEventId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        async function loadEventDetails() {
            // ... (keep existing load logic, just ensure button logic is available globally)
            // Actually, defining them on window is easiest since onclicks need them
            window.toggleLike = function () {
                const id = getEventId();
                const btn = document.getElementById('likeBtn');
                const icon = btn.querySelector('i');

                let savedEvents = JSON.parse(localStorage.getItem('savedEvents')) || [];
                const index = savedEvents.indexOf(id);

                if (index === -1) {
                    savedEvents.push(id);
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    icon.style.color = 'red';
                    alert("Event added to favorites!");
                } else {
                    savedEvents.splice(index, 1);
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    icon.style.color = ''; // reset
                    alert("Event removed from favorites.");
                }
                localStorage.setItem('savedEvents', JSON.stringify(savedEvents));
            };

            window.openShareModal = function () {
                const link = window.location.href;
                document.getElementById('eventLink').value = link;
                document.getElementById('shareModal').style.display = 'flex';
            };

            window.closeShareModal = function () {
                document.getElementById('shareModal').style.display = 'none';
            };

            window.copyEventLink = function () {
                const copyText = document.getElementById("eventLink");
                copyText.select();
                document.execCommand("copy");
                alert("Link copied to clipboard!");
            };

            window.shareOnFacebook = function () {
                const link = window.location.href;
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`, '_blank');
            };

            window.shareOnTwitter = function () {
                const link = window.location.href;
                window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(link)}`, '_blank');
            };

            window.shareOnWhatsApp = function () {
                const link = window.location.href;
                window.open(`https://wa.me/?text=${encodeURIComponent(link)}`, '_blank');
            };

            // --- Booking Functions ---
            window.ticketQuantity = 1;

            window.openBooking = function () {
                const user = auth.currentUser;
                if (!user) {
                    // Check if user is logged in
                    alert("Please log in to book tickets.");
                    window.location.href = `login.html`;
                    return;
                }

                if (!window.currentEvent) {
                    alert("Event data not loaded.");
                    return;
                }

                // Reset state
                window.ticketQuantity = 1;
                document.getElementById('ticketQuantity').innerText = 1;

                // Populate Modal
                document.getElementById('modalEventTitle').innerText = window.currentEvent.title;
                document.getElementById('modalTicketPrice').innerText = `${window.currentEvent.currency || 'â‚¹'}${window.currentEvent.price}`;
                updateTotalPrice();

                document.getElementById('bookingModal').style.display = 'flex';
            };

            window.closeBookingModal = function () {
                document.getElementById('bookingModal').style.display = 'none';
            };

            window.updateQuantity = function (change) {
                let newQ = window.ticketQuantity + change;
                if (newQ < 1) newQ = 1;
                if (newQ > 10) newQ = 10; // Max limit
                window.ticketQuantity = newQ;
                document.getElementById('ticketQuantity').innerText = newQ;
                updateTotalPrice();
            };

            function updateTotalPrice() {
                const price = window.currentEvent.price || 0;
                const total = price * window.ticketQuantity;
                document.getElementById('modalTotalPrice').innerText = `${window.currentEvent.currency || 'â‚¹'}${total}`;
            }

            window.initiatePayment = function () {
                const price = window.currentEvent.price || 0;
                const totalAmount = price * window.ticketQuantity * 100; // Razorpay needs paise

                const options = {
                    "key": "rzp_live_3f0xF7yLVO9UKP",
                    "amount": totalAmount,
                    "currency": "INR",
                    "name": "CornerClub",
                    "description": `Ticket for ${window.currentEvent.title}`,
                    "image": "https://cornerclub.in/logo.png",
                    "handler": async function (response) {
                        // On Success
                        console.log(response);

                        // 1. Close Booking Modal Immediately
                        closeBookingModal();

                        // 2. Show Loading/Processing State (using the main loading spinner or a toast)
                        const loadingDiv = document.getElementById('loading');
                        loadingDiv.style.display = 'block';
                        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x"></i><p>Processing your booking...</p>';

                        try {
                            // 3. Save Booking to Firestore with Custom ID
                            // Format: UserEmail_EventTitle_Timestamp
                            const userEmail = auth.currentUser.email || "unknown";
                            const safeEmail = userEmail.replace(/[^a-zA-Z0-9]/g, "");
                            const safeTitle = window.currentEvent.title.replace(/[^a-zA-Z0-9]/g, "");
                            const customId = `${safeEmail}_${safeTitle}_${Date.now()}`;

                            await setDoc(doc(db, "bookings", customId), {
                                eventId: window.currentEvent.id,
                                eventTitle: window.currentEvent.title,
                                userId: auth.currentUser.uid,
                                userName: auth.currentUser.displayName || auth.currentUser.email,
                                quantity: window.ticketQuantity,
                                totalPrice: price * window.ticketQuantity,
                                paymentId: response.razorpay_payment_id,
                                bookedAt: serverTimestamp(),
                                status: 'confirmed'
                            });

                            // 4. Hide Loading
                            loadingDiv.style.display = 'none';

                            // 5. Show Ticket
                            showTicket({
                                id: response.razorpay_payment_id.substr(-6).toUpperCase(),
                                count: window.ticketQuantity
                            });

                            // 6. Send Emails (Background)
                            sendBookingEmails({
                                totalPrice: price * window.ticketQuantity
                            }, response.razorpay_payment_id.substr(-6).toUpperCase());

                        } catch (err) {
                            console.error("Booking save error", err);
                            loadingDiv.style.display = 'none';
                            alert("Payment successful but failed to save booking. Please contact support with Payment ID: " + response.razorpay_payment_id);
                        }
                    },
                    "prefill": {
                        "name": auth.currentUser.displayName || "",
                        "email": auth.currentUser.email || "",
                        "contact": ""
                    },
                    "theme": {
                        "color": "#6d28d9"
                    },
                    "modal": {
                        "ondismiss": function () {
                            console.log('Checkout form closed');
                        }
                    }
                };

                const rzp1 = new Razorpay(options);
                rzp1.open();
                rzp1.on('payment.failed', function (response) {
                    alert("Payment Failed: " + response.error.description);
                });
            };

            window.showTicket = function (booking) {
                document.getElementById('ticketEventTitle').innerText = window.currentEvent.title;
                // Format Date properly using currentEvent data
                const dateObj = new Date(window.currentEvent.date);
                const dateStr = dateObj.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                document.getElementById('ticketDate').innerText = `${dateStr} @ ${window.currentEvent.time}`;
                document.getElementById('ticketLocation').innerText = window.currentEvent.location.split(',')[0]; // Shorten location
                document.getElementById('ticketId').innerText = `#${booking.id}`;
                document.getElementById('ticketCount').innerText = `${booking.count} Person(s)`;

                // QR Code with unique data
                const qrData = `BOOKING:${booking.id}|EVENT:${window.currentEvent.id}`;
                document.getElementById('ticketQR').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;

                document.getElementById('ticketModal').style.display = 'flex';

                // Trigger Confetti!
                var count = 200;
                var defaults = {
                    origin: { y: 0.7 }
                };

                function fire(particleRatio, opts) {
                    confetti(Object.assign({}, defaults, opts, {
                        particleCount: Math.floor(count * particleRatio)
                    }));
                }

                fire(0.25, {
                    spread: 26,
                    startVelocity: 55,
                });
                fire(0.2, {
                    spread: 60,
                });
                fire(0.35, {
                    spread: 100,
                    decay: 0.91,
                    scalar: 0.8
                });
                fire(0.1, {
                    spread: 120,
                    startVelocity: 25,
                    decay: 0.92,
                    scalar: 1.2
                });
                fire(0.1, {
                    spread: 120,
                    startVelocity: 45,
                });
            };

            window.downloadTicket = function () {
                alert("Downloading ticket... (Feature coming soon!)");
                // In a real app, you'd generate a PDF or image here using html2canvas or jsPDF
            };

            window.closeTicketModal = function () {
                document.getElementById('ticketModal').style.display = 'none';
            };

            async function sendBookingEmails(bookingData, bookingId) {
                const userEmail = auth.currentUser.email;
                const userName = auth.currentUser.displayName || "User";
                const eventName = window.currentEvent.title;
                const organizerEmail = window.currentEvent.organizerEmail || "organizer@example.com"; // Provide a fallback or ensure data has it

                // 1. User Email - Ticket Confirmation
                const userTemplateParams = {
                    to_email: userEmail,
                    to_name: userName,
                    event_name: eventName,
                    booking_id: bookingId,
                    tickets: window.ticketQuantity,
                    amount: bookingData.totalPrice,
                    date: window.currentEvent.date,
                    location: window.currentEvent.location,
                    qr_link: `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=BOOKING:${bookingId}`
                };

                // 2. Organizer Email - Ticket Sold Notification
                const orgTemplateParams = {
                    to_email: organizerEmail,
                    event_name: eventName,
                    customer_name: userName,
                    customer_email: userEmail,
                    tickets_sold: window.ticketQuantity,
                    total_amount: bookingData.totalPrice,
                    booking_id: bookingId
                };

                console.log("Attempting to send SUCCESS emails...", userTemplateParams, orgTemplateParams);

                // IMPORTANT: Ensure 'template_2gfc0za' in EmailJS is the "Booking Confirmation" template, NOT a failure notification.
                // If the email says "Payment Failed", please edit the template in the EmailJS dashboard.

                // Use Promise.all to send both in parallel without blocking UI too much
                try {
                    // Replace 'service_id' and 'template_id' with your actual EmailJS IDs
                    const p1 = emailjs.send('service_j79tv6e', 'template_2gfc0za', userTemplateParams);
                    const p2 = emailjs.send('service_j79tv6e', 'template_ta4g5zc', orgTemplateParams);
                    await Promise.all([p1, p2]);
                    console.log("SUCCESS emails sent successfully!");
                } catch (error) {
                    console.error("Failed to send emails", error);
                }
            }

            const id = getEventId();


            if (!id) {
                showError();
                return;
            }

            try {
                // OPTIMIZATION: Check for Sample/Legacy IDs FIRST
                // This avoids a slow network call for static data
                if (['1', '2', '3', '4', '5', '6'].includes(id)) {
                    console.log("Loading sample event immediately:", id);
                    const sampleData = getSampleData(id);
                    if (sampleData) {
                        renderEvent(sampleData);
                        return; // Done, skip Firebase
                    }
                }

                // If not sample, Try Firebase
                try {
                    console.log("Fetching event from Firestore:", id);
                    const docRef = doc(db, "events", id);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        renderEvent({ id: docSnap.id, ...docSnap.data() });
                    } else {
                        console.log("No such event in Firestore");
                        showError();
                    }
                } catch (e) {
                    console.error("Firebase fetch failed:", e);
                    showError();
                }

            } catch (error) {
                console.error("Error:", error);
                showError();
            }
        }

        function renderEvent(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('eventContent').style.display = 'block';

            // Populate fields
            document.title = `${data.title} - CornerClub`;
            document.getElementById('eventImage').src = data.image || data.image_url || 'https://via.placeholder.com/800x400';
            document.getElementById('eventTitle').innerText = data.title;
            document.getElementById('eventDate').innerText = new Date(data.date).toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('eventTime').innerText = data.time;
            document.getElementById('eventLocation').innerText = data.location;
            document.getElementById('eventPrice').innerText = `${data.currency || 'â‚¹'}${data.price}`;
            document.getElementById('eventDescription').innerText = data.description;

            // Portfolio Rendering
            const portfolioSection = document.getElementById('portfolioSection');
            const portfolioContainer = document.getElementById('portfolioContainer');

            if (data.portfolioImages && Array.isArray(data.portfolioImages) && data.portfolioImages.length > 0) {
                portfolioSection.style.display = 'block';
                portfolioContainer.innerHTML = '';
                data.portfolioImages.forEach(imgSrc => {
                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.className = 'portfolio-img';
                    // Optional: Simple lightbox or open in new tab
                    img.onclick = () => window.open(imgSrc, '_blank');
                    portfolioContainer.appendChild(img);
                });
            } else {
                portfolioSection.style.display = 'none';
            }

            document.getElementById('organizerName').innerText = data.organizer ? data.organizer.name : 'CornerClub Host';

            document.getElementById('totalCapacity').innerText = data.capacity || 100;

            // Social Media Links
            const socialContainer = document.getElementById('organizerSocials');
            const instagramLink = (data.organizer && data.organizer.instagram) || (data.hostInstagram);
            const twitterLink = (data.organizer && data.organizer.twitter) || (data.hostTwitter);

            let socialHtml = '';
            if (instagramLink) {
                socialHtml += `<a href="${instagramLink}" target="_blank" style="text-decoration:none; margin-right:10px;">
                    <i class="fab fa-instagram" style="color: #e1306c; font-size: 1.2rem;"></i>
                </a>`;
            }
            // Fallback visualization if we want to show it enabled for demo/testing
            else if (data.organizer && data.organizer.name === 'Umaesh') {
                // Hardcoded for specific user if data missing, as per screenshot
                socialHtml += `<a href="https://instagram.com" target="_blank" style="text-decoration:none; margin-right:10px;">
                    <i class="fab fa-instagram" style="color: #e1306c; font-size: 1.2rem;"></i>
                </a>`;
            } else {
                // Show inactive if no link
                socialHtml += `<i class="fab fa-instagram" style="color: #ccc; font-size: 1.2rem; cursor: not-allowed;" title="No social link"></i>`;
            }

            if (twitterLink) {
                socialHtml += `<a href="${twitterLink}" target="_blank" style="text-decoration:none; margin-right:10px;">
                    <i class="fab fa-twitter" style="color: #1DA1F2; font-size: 1.2rem;"></i>
                </a>`;
            }

            socialContainer.innerHTML = socialHtml;
            // Mock spots left
            document.getElementById('spotsLeft').innerText = (data.capacity || 100) - Math.floor(Math.random() * 20) + " spots left";

            // Initialize Like State
            const savedEvents = JSON.parse(localStorage.getItem('savedEvents')) || [];
            if (savedEvents.includes(String(data.id))) {
                const btn = document.getElementById('likeBtn');
                const icon = btn.querySelector('i');
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.style.color = 'red';
            }

            // Expose data for booking
            window.currentEvent = data;

            // Initialize Chat with Event Details
            initChat(data);
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
        }

        // Mock function to replicate sample data from index.html for smooth transition
        function getSampleData(id) {
            const samples = [
                { id: 1, title: "Indie Music Night", category: "Music", date: "2024-04-15", time: "19:00", location: "The Blue Room, Mumbai", price: 499, currency: "â‚¹", capacity: 150, image: "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=800&h=400&fit=crop", description: "An evening of indie music featuring local artists" },
                { id: 2, title: "Food Festival 2024", category: "Food", date: "2024-04-20", time: "12:00", location: "Phoenix Marketcity, Pune", price: 299, currency: "â‚¹", capacity: 500, image: "https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=800&h=400&fit=crop", description: "Taste food from 50+ restaurants across the city" }
                // Add others if needed or rely on Firestore for real data
            ];
            return samples.find(s => s.id == id);
        }

        // Legacy Direct Booking (Bypasses Payment - specialized use only)
        window.openBookingLegacy = async function () {
            const user = auth.currentUser;
            if (!user) {
                // Determine current URL to redirect back after login (optional enhancement)
                alert("Please log in to book tickets.");
                window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
                return;
            }

            // User is logged in, proceed to book
            const eventId = getEventId();
            const eventTitle = document.getElementById('eventTitle').innerText;
            const bookBtn = document.querySelector('.book-btn');

            try {
                bookBtn.disabled = true;
                bookBtn.innerText = "Booking...";

                // Create Custom ID: UserEmail_EventTitle_Timestamp
                const userEmail = user.email || "unknown";
                const safeEmail = userEmail.replace(/[^a-zA-Z0-9]/g, "");
                const safeTitle = eventTitle.replace(/[^a-zA-Z0-9]/g, "");
                const customId = `${safeEmail}_${safeTitle}_${Date.now()}`;

                await setDoc(doc(db, "bookings", customId), {
                    userId: user.uid,
                    userName: user.displayName || "User",
                    userEmail: user.email,
                    eventId: eventId,
                    eventTitle: eventTitle,
                    bookedAt: new Date().toISOString(),
                    status: 'confirmed'
                });

                alert("Booking Confirmed! You can view it in your profile.");
                bookBtn.innerText = "Booked âœ…";
                // Optional: Redirect to profile
                // window.location.href = 'profile.html';

            } catch (error) {
                console.error("Booking Error:", error);
                alert("Failed to book event: " + error.message);
                bookBtn.disabled = false;
                bookBtn.innerText = "Book Now";
            }
        }

        // Run
        loadEventDetails();

        function initChat(eventData) {
            const eventId = eventData.id;
            const eventTitle = eventData.title || "Event";

            // Construct a readable Chat Room ID: "Title_ID"
            // Remove special characters from title for cleaner ID
            const safeTitle = eventTitle.replace(/[^a-zA-Z0-9 ]/g, "").replace(/\s+/g, "_");
            const chatRoomId = `${safeTitle}_${eventId}`;

            console.log("Initializing chat for room:", chatRoomId);
            if (!eventId) {
                console.error("No event ID provided for chat.");
                return;
            }

            const chatMessages = document.getElementById('chatMessages');
            const chatInputArea = document.getElementById('chatInputArea');
            const chatLoginPrompt = document.getElementById('chatLoginPrompt');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendMessageBtn');

            // Check Auth State for UI
            auth.onAuthStateChanged(user => {
                if (user) {
                    chatInputArea.style.display = 'flex';
                    chatLoginPrompt.style.display = 'none';
                } else {
                    chatInputArea.style.display = 'none';
                    chatLoginPrompt.style.display = 'block';
                }
            });

            // Listen for messages
            // Listen for messages
            const q = query(
                collection(db, "chats", chatRoomId, "messages"),
                orderBy("createdAt", "asc")
            );

            onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                if (snapshot.empty) {
                    chatMessages.innerHTML = '<div style="text-align: center; color: #666; margin-top: 80px;"><p>No messages yet. Be the first to say hi!</p></div>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isOwn = auth.currentUser && msg.userId === auth.currentUser.uid;

                    const msgDiv = document.createElement('div');
                    msgDiv.className = `message ${isOwn ? 'own' : 'other'}`;

                    const senderName = document.createElement('div');
                    senderName.className = 'message-sender';
                    senderName.innerText = msg.userName || 'User';

                    const textDiv = document.createElement('div');
                    textDiv.innerText = msg.text;

                    msgDiv.appendChild(senderName);
                    msgDiv.appendChild(textDiv);
                    chatMessages.appendChild(msgDiv);
                });

                // Auto scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, (error) => {
                console.error("Chat Error:", error);
                chatMessages.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 20px;">
                    <p>Error loading chat: ${error.message}</p>
                    <p style="font-size: 12px; opacity: 0.8;">Ensure you are connected to the internet.</p>
                </div>`;
            });

            // Send Message
            async function sendMessage() {
                const text = messageInput.value.trim();
                const user = auth.currentUser;

                if (!text || !user) return;

                try {
                    messageInput.value = '';
                    messageInput.focus();

                    await addDoc(collection(db, "chats", chatRoomId, "messages"), {
                        text: text,
                        userId: user.uid,
                        userName: user.displayName || user.email?.split('@')[0] || "User",
                        createdAt: serverTimestamp(),
                        eventTitle: eventTitle // Storing title for reference
                    });
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("Failed to send message.");
                }
            }

            sendBtn.onclick = sendMessage;
            messageInput.onkeypress = (e) => {
                if (e.key === 'Enter') sendMessage();
            }
        }

    </script>
</body>

</html>